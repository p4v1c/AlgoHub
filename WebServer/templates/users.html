<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD Users - Security Scan Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- STYLES CSS GLOBAUX --- */
        :root {
            --bg-body: #F5F7FA; --bg-navbar: #FFFFFF; --bg-card: #FFFFFF; --bg-hover: #F0F2F5; --bg-separator: #E1E4E8;
            --text-primary: #1A1F36; --text-secondary: #697386; --text-muted: #A0AEC0;
            --accent-color: #3B82F6; --accent-subtle: #EBF5FF;
            --success: #10B981; --success-subtle: #D1FAE5;
            --warning: #F59E0B; --warning-subtle: #FEF3C7;
            --danger: #EF4444; --danger-subtle: #FEF2F2;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05); --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --radius-md: 12px; --radius-sm: 8px;
            --json-key: #CF222E; --json-string: #0A3069; --json-number: #0550AE; --json-boolean: #0550AE;
        }
        [data-theme="dark"] {
            --bg-body: #0F111A; --bg-navbar: #1A1D2E; --bg-card: #1F2338; --bg-hover: #2A2F4A; --bg-separator: #2F354F;
            --text-primary: #E2E8F0; --text-secondary: #A0AEC0; --text-muted: #64748B;
            --accent-color: #00E5FF; --accent-subtle: rgba(0, 229, 255, 0.1);
            --success: #76FF03; --success-subtle: rgba(118, 255, 3, 0.1);
            --warning: #FFC400; --warning-subtle: rgba(255, 196, 0, 0.1);
            --danger: #FF3D71; --danger-subtle: rgba(255, 61, 113, 0.1);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.2); --shadow-md: 0 4px 20px rgba(0, 229, 255, 0.05);
            --json-key: #FF7B72; --json-string: #A5D6FF; --json-number: #79C0FF; --json-boolean: #79C0FF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; overflow-x: hidden; }

        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: var(--bg-navbar); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--bg-separator); }
        .nav-left, .nav-right { display: flex; align-items: center; gap: 1rem; }
        .brand-title { font-weight: 700; font-size: 1.2rem; margin-right: 2rem; display: flex; align-items: center; }
        .brand-title span { color: var(--accent-color); }
        .btn { padding: 0.6rem 1.2rem; border-radius: var(--radius-sm); font-weight: 600; text-decoration: none; transition: all 0.2s ease; font-size: 0.9rem; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-outline { border: 2px solid var(--bg-separator); color: var(--text-primary); background: transparent; }
        .btn-outline:hover { border-color: var(--accent-color); color: var(--accent-color); background-color: var(--accent-subtle); }
        .theme-toggle-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; padding: 0.5rem; border-radius: 50%; transition: color 0.3s ease; }
        .theme-toggle-btn:hover { color: var(--accent-color); background-color: var(--bg-hover); }
        .icon-sm { width: 18px; height: 18px; } .icon-md { width: 24px; height: 24px; }

        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.8rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }
        
        /* TABS DC */
        .dc-tabs-container { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .dc-tab { padding: 0.75rem 1.5rem; border: 1px solid var(--bg-separator); background: var(--bg-card); color: var(--text-secondary); border-radius: var(--radius-sm); cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .dc-tab:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .dc-tab.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        .search-container { margin-bottom: 1.5rem; position: relative; }
        .search-input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border-radius: var(--radius-md); border: 1px solid var(--bg-separator); background-color: var(--bg-card); color: var(--text-primary); font-family: inherit; font-size: 0.95rem; }
        .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .card { background-color: var(--bg-card); border-radius: var(--radius-md); box-shadow: var(--shadow-md); border: 1px solid var(--bg-separator); overflow: hidden; }
        .clean-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: left; }
        .clean-table th, .clean-table td { padding: 0.85rem 1rem; border-bottom: 1px solid var(--bg-separator); vertical-align: middle; }
        .clean-table th { background-color: var(--bg-hover); font-weight: 600; color: var(--text-secondary); white-space: nowrap; position: sticky; top: 0; }
        .clean-table tbody tr:hover { background-color: var(--bg-hover); cursor: pointer; }
        .user-row td:first-child { font-weight: 600; color: var(--accent-color); }

        .badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background-color: var(--success-subtle); color: var(--success); }
        .badge-danger { background-color: var(--danger-subtle); color: var(--danger); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; }
        .modal-container { background-color: var(--bg-card); width: 90%; max-width: 800px; max-height: 90vh; border-radius: var(--radius-md); box-shadow: var(--shadow-md); display: flex; flex-direction: column; border: 1px solid var(--bg-separator); }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--bg-separator); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 700; font-size: 1.2rem; }
        .close-modal-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem; line-height: 1; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }

        .json-tree { font-family: 'Fira Code', 'Roboto Mono', monospace; font-size: 0.9rem; line-height: 1.6; }
        .json-tree ul { list-style: none; margin: 0; padding: 0 0 0 1.5rem; border-left: 1px solid var(--bg-separator); }
        .json-tree > ul { border-left: none; padding-left: 0; }
        .json-tree li { margin-bottom: 0.25rem; }
        .json-key { color: var(--json-key); } .json-string { color: var(--json-string); } .json-number { color: var(--json-number); } .json-boolean { color: var(--json-boolean); } .json-null { color: var(--text-muted); font-style: italic; }
        .json-togglable { cursor: pointer; display: flex; align-items: center; }
        .json-togglable::before { content: '▸'; display: inline-block; margin-right: 5px; color: var(--text-muted); transition: transform 0.2s; }
        .json-togglable.open::before { transform: rotate(90deg); }
        .json-togglable.open + ul { display: block; }
        .json-togglable + ul { display: none; }
    </style>
</head>
<body data-theme="light">

    <nav class="navbar">
        <div class="nav-left">
            <div class="brand-title">
                <svg class="icon-md" style="margin-right: 10px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span>Sec</span>Ops View
            </div>
            <a href="/" class="btn btn-outline" style="gap: 0.3rem;">
                <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Retour au Dashboard
            </a>
        </div>
        <div class="nav-right">
            <button id="theme-toggle" class="theme-toggle-btn">
                <svg id="sun-icon" class="icon-md" style="display: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moon-icon" class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <div class="page-title">
                <svg class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                Annuaire Utilisateurs AD
            </div>
            <div id="user-count" style="color: var(--text-secondary); font-weight: 600;"></div>
        </div>

        <div id="loading-state">Chargement des utilisateurs...</div>
        <div id="error-state" style="display: none;"></div>

        <div id="users-content" style="display: none;">
            <div id="dc-tabs" class="dc-tabs-container"></div>

            <div class="search-container">
                <svg class="search-icon icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" id="user-search" class="search-input" placeholder="Rechercher un utilisateur...">
            </div>

            <div class="card">
                <div class="table-container">
                    <table class="clean-table" id="users-table">
                        <thead>
                            <tr>
                                <th>Compte (sAMAccountName)</th>
                                <th>Description</th>
                                <th>Statut</th>
                                <th>Dernière connexion</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="user-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title" id="modal-user-title">Détails Utilisateur</div>
                <button class="close-modal-btn" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-json-content" class="json-tree"></div>
            </div>
        </div>
    </div>

<script>
    // --- Globales ---
    let currentDCIndex = 0;
    let allADData = []; // Stocke la liste des DCs
    let currentUsersList = []; // Liste affichée actuellement
    
    const modal = document.getElementById('user-modal');
    const modalTitle = document.getElementById('modal-user-title');
    const modalContent = document.getElementById('modal-json-content');

    // --- Theme Logic ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');
    const body = document.body;
    const currentTheme = localStorage.getItem('theme') || 'light';
    body.setAttribute('data-theme', currentTheme);
    updateThemeIcons(currentTheme);
    themeToggleBtn.addEventListener('click', () => {
        const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcons(newTheme);
    });
    function updateThemeIcons(theme) {
        sunIcon.style.display = theme === 'dark' ? 'block' : 'none';
        moonIcon.style.display = theme === 'light' ? 'block' : 'none';
    }

    // --- Helpers ---
    function isAccountDisabled(uac) {
        const uacInt = parseInt(uac, 10);
        if (isNaN(uacInt)) return false;
        return (uacInt & 2) === 2;
    }
    function formatAdTimestamp(timestamp) {
        if (!timestamp || timestamp.startsWith("1601") || timestamp === "0") return '<span style="color: var(--text-muted);">Jamais connecté</span>';
        try { return new Date(timestamp).toLocaleString('fr-FR', { dateStyle: 'medium', timeStyle: 'short' }); } catch (e) { return timestamp; }
    }
    function safeLower(val) {
        if (val === null || val === undefined) return '';
        if (Array.isArray(val)) return val.join(' ').toLowerCase();
        return String(val).toLowerCase();
    }
    
    // --- JSON Tree ---
    function renderJsonTree(data) {
        if (data === null) return '<span class="json-null">null</span>';
        if (typeof data === 'undefined') return '<span class="json-null">undefined</span>';
        if (typeof data !== 'object') {
            const type = typeof data;
            if (type === 'string') return `<span class="json-string">"${data.replace(/"/g, '&quot;')}"</span>`;
            if (type === 'number') return `<span class="json-number">${data}</span>`;
            if (type === 'boolean') return `<span class="json-boolean">${data}</span>`;
            return `<span>${data}</span>`;
        }
        let html = '<ul>';
        for (const key in data) {
            const value = data[key];
            const isObject = typeof value === 'object' && value !== null;
            html += '<li>';
            if (isObject && Object.keys(value).length > 0) {
                 html += `<span class="json-togglable"><span class="json-key">"${key}"</span>: </span>${renderJsonTree(value)}`;
            } else {
                html += `<span class="json-key">"${key}"</span>: ${renderJsonTree(value)}`;
            }
            html += '</li>';
        }
        html += '</ul>';
        return html;
    }

    // --- Core Logic ---

    function openUserModal(userData) {
        modalTitle.textContent = `Détails: ${userData.sAMAccountName}`;
        modalContent.innerHTML = renderJsonTree(userData);
        modal.classList.add('active');
        modalContent.querySelectorAll('.json-togglable').forEach(togglable => {
            togglable.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('open');
            });
        });
    }

    document.getElementById('close-modal').addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

    function renderDCButtons() {
        const container = document.getElementById('dc-tabs');
        container.innerHTML = '';

        if (allADData.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted); font-style:italic;">Aucun domaine disponible.</div>';
            return;
        }

        allADData.forEach((dc, index) => {
            const btn = document.createElement('button');
            const name = dc.domain !== "Unknown" ? dc.domain : dc.dc_name;
            btn.className = `dc-tab ${index === currentDCIndex ? 'active' : ''}`;
            btn.textContent = name;
            
            btn.addEventListener('click', () => {
                currentDCIndex = index;
                // Update active state visuals
                document.querySelectorAll('.dc-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update data
                loadUsersForCurrentDC();
            });
            container.appendChild(btn);
        });
    }

    function loadUsersForCurrentDC() {
        currentUsersList = [];
        const dcData = allADData[currentDCIndex];
        if (dcData && dcData.ldeep) {
            const usersFile = dcData.ldeep.find(f => f.file === 'users.json');
            if (usersFile && usersFile.data) {
                currentUsersList = usersFile.data;
            }
        }
        renderUsersTable(currentUsersList);
    }

    function renderUsersTable(users) {
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';
        document.getElementById('user-count').textContent = `${users.length} utilisateur(s)`;

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem; color: var(--text-muted);">Aucun utilisateur trouvé pour ce DC.</td></tr>';
            return;
        }

        users.forEach(user => {
            const tr = document.createElement('tr');
            tr.className = 'user-row';
            const isDisabled = isAccountDisabled(user.userAccountControl);
            const statusBadge = isDisabled ? '<span class="badge badge-danger">Désactivé</span>' : '<span class="badge badge-success">Activé</span>';
            let descDisplay = user.description;
            if (Array.isArray(descDisplay)) descDisplay = descDisplay.join(', ');

            tr.innerHTML = `
                <td>${user.sAMAccountName || '-'}</td>
                <td>${descDisplay || '<span style="color:var(--text-muted); font-style:italic;">N/A</span>'}</td>
                <td>${statusBadge}</td>
                <td>${formatAdTimestamp(user.lastLogonTimestamp)}</td>
            `;
            tr.addEventListener('click', () => openUserModal(user));
            tbody.appendChild(tr);
        });
    }

    document.getElementById('user-search').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredUsers = currentUsersList.filter(user => {
            const sam = safeLower(user.sAMAccountName);
            const desc = safeLower(user.description);
            const display = safeLower(user.displayName);
            return sam.includes(searchTerm) || desc.includes(searchTerm) || display.includes(searchTerm);
        });
        renderUsersTable(filteredUsers);
    });

    document.addEventListener('DOMContentLoaded', () => {
        fetch('/api/data')
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('users-content').style.display = 'block';

                if (data.ad_enumeration && Array.isArray(data.ad_enumeration)) {
                    allADData = data.ad_enumeration;
                    renderDCButtons();
                    loadUsersForCurrentDC();
                } else {
                    document.getElementById('users-table-body').innerHTML = '<tr><td colspan="4">Données invalides reçues du serveur.</td></tr>';
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-state').innerHTML = `Erreur: ${err.message}`;
            });
    });
</script>
</body>
</html>